#!/usr/bin/env bash

set -e

FWDIR="$(cd `dirname $0`/..; pwd)"

export PIO_HOME="$FWDIR"

. $FWDIR/bin/load-pio-env.sh

if [ -z "$1" ]; then
  echo "Usage: pio-run <runner-class>" 1>&2
  exit 1
fi

SBT=sbt

if [ -x $FWDIR/sbt/sbt ]; then
  SBT=$FWDIR/sbt/sbt
fi

if [ ! -f target/scala*/*-assembly-*-deps.jar ]; then
  $SBT assemblyPackageDependency
fi

$SBT package

ASSEMBLY_DIR="$FWDIR/assembly"

if [ -f "$FWDIR/RELEASE" ]; then
  assembly_folder="$FWDIR"/lib
else
  assembly_folder="$ASSEMBLY_DIR"
fi

ASSEMBLY_JAR=$(ls "$assembly_folder"/tools-assembly*.jar 2>&-)

ENGINE_DEPS_JAR=$(ls target/scala*/*-assembly-*-deps.jar 2>&-)

CLASSNAME=$1

shift

$SPARK_HOME/bin/spark-submit --jars $ASSEMBLY_JAR,$ENGINE_DEPS_JAR --class $CLASSNAME target/scala*/*_*-*.jar "$@"
