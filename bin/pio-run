#!/usr/bin/env bash

set -e

FWDIR="$(cd `dirname $0`/..; pwd)"

export PIO_HOME="$FWDIR"

. $FWDIR/bin/load-pio-env.sh

if [ -z "$1" ]; then
  echo "Usage: pio-run <runner-class>" 1>&2
  exit 1
fi

SBT=sbt

if [ -x $FWDIR/sbt/sbt ]; then
  SBT=$FWDIR/sbt/sbt
fi

if [ ! -f target/scala*/*-assembly-*-deps.jar ]; then
  $SBT assemblyPackageDependency
fi

$SBT package

CLASSNAME=$1

shift

$SPARK_HOME/bin/spark-submit --jars target/scala*/*-assembly-*-deps.jar --class $CLASSNAME target/scala*/*_*-*.jar "$@"
